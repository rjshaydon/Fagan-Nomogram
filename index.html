<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fagan Nomogram (Single File)</title>
<style>
/* ========== style.css inlined ========== */
#app-header {
  width: 100%;
  text-align: center;
  padding: 0.6rem 0;
  background: #fff;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  position: relative;
  z-index: 20;
}
#app-header h1 {
  position: static;
  transform: none;
  margin: 0;
  font-size: 1.5rem;
}
body {
  margin: 0;
  font-family: system-ui, Arial, sans-serif;
  background: #f9f9f9;
  color: #222;
}
main {
  width: 100vw;
  min-height: calc(100vh - 60px);
  display: flex;
  flex-direction: row;
  align-items: stretch;
  justify-content: center;
  box-sizing: border-box;
  padding: 0;
  max-width: none;
  position: relative;
}
#canvas-container {
  flex: 1 1 0;
  min-width: 320px;
  max-width: 900px;
  width: 60vw;
  height: 80vh;
  min-height: 400px;
  background: #fff;
  border-radius: 12px 0 0 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 1;
}
#faganCanvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
  background: #f4f7fa;
  border-radius: 8px;
  touch-action: none;
}
#output-container {
  flex: 1 1 0;
  min-width: 320px;
  max-width: 400px;
  margin: 0;
  z-index: 10;
}
#output {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  width: 100%;
  background: #fff;
  border-radius: 0 12px 12px 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  padding-top: 2rem;
  /* existing padding: 2rem 1.5rem; */
  padding: 2rem 1.5rem 2rem;
  font-size: 1rem;
  gap: 0.5rem;
  align-items: center;
  height: 80vh;
  box-sizing: border-box;
}
#output > div {
  display: flex;
  justify-content: space-between;
  width: 100%;
}
#slideup-tab {
  display: block;
  position: static;
  width: 100%;
  padding: 0.5rem 1rem;
  font-weight: bold;
  font-size: 1.1rem;
  color: #2a4a7b;
  border-bottom: 1px solid #eee;
  box-sizing: border-box;
  text-align: center;
  margin-bottom: 1rem;
}
@media (max-width: 600px) {
  main {
    flex-direction: column;
    overflow: hidden;
    min-height: calc(100vh - 60px);
  }
  #canvas-container {
    width: 100vw;
    height: calc(100vh - 60px - 2.5rem);
    min-height: 220px;
    border-radius: 0;
    box-shadow: none;
    margin: 0;
    position: relative;
  }
    #output-container {
    position: fixed;
    left: 0;
    right: 0;
    /* sit immediately under the tab */
    top: 2.5rem;
    bottom: 0;
    z-index: 2;
    /* closed = just show tab, open = full height */
    transform: translateY(calc(100% - 2.5rem));
    transition: transform 0.3s ease;
    width: 100%;
    max-width: 100%;

  }  #output-container.slideup {
    transform: translateY(0);
    z-index: 100;
  }
  #output {
    width: 100%; height: 100%; padding: 0 1rem 1rem;
    overflow-y: auto;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -2px 16px rgba(0,0,0,0.13);
    box-sizing: border-box;
    padding-top: 3.5rem;
  }
  #slideup-tab {
    display: flex;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    padding: 0 1.5rem;
    top: 0;
    height: 2.5rem;
    line-height: 2.5rem;
    background: #fff;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.10);
    font-weight: bold;
    font-size: 1.1rem;
    color: #2a4a7b;
    cursor: pointer;
    user-select: none;
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 101;
  }
  #output input[type="number"] {
    font-size: 14px;
  }
}
/* Help overlay */
#help-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
}
#help-overlay .help-content {
  background: #fff;
  padding: 2rem;
  border-radius: 8px;
  text-align: center;
  max-width: 600px;
}
#help-overlay .help-content h1 {
  margin: 0 0 1rem;
  font-size: 2rem;
}
#help-overlay .help-content p {
  margin: 0 0 1rem;
  font-style: italic;
  font-size: 1rem;
}

/* Info-icon styling beside the tab label */
/* Info-icon styling beside the tab label */
#slideup-tab .info-icon {
  margin-left: 0.5rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
}
#slideup-tab .info-icon svg {
  width: 1.2em;
  height: 1.2em;
  color: #2a4a7b;
}
/* ========== end CSS ========== */
</style>
</head>
<body>
  <header id="app-header"><h1>Fagan Nomogram</h1></header>
  <main>
    <div id="canvas-container">
      <canvas id="faganCanvas" tabindex="0"></canvas>
    </div>
    <div id="output-container" class="slideup">
      <div id="output">
        <div id="slideup-tab">
          Values & Settings
          <span id="help-icon" class="info-icon" title="Help">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="2" fill="none"/>
              <circle cx="12" cy="7" r="1" fill="currentColor"/>
              <rect x="11" y="10" width="2" height="8" fill="currentColor"/>
            </svg>
          </span>
        </div>
        <div>
          <span style="font-weight:bold; font-size:0.9rem;">Pre-test Probability:</span>
          <span><input id="pretest-input" type="number" min="0.1" max="99.9" step="0.1" style="width:60px;" />%</span>
        </div>
        <div>
          <span style="font-size:0.8rem;">Sensitivity:</span>
          <span><input id="sensitivity-input" type="number" min="0.1" max="99.9" step="0.1" style="width:60px;" />%</span>
        </div>
        <div>
          <span style="font-size:0.8rem;">Specificity:</span>
          <span><input id="specificity-input" type="number" min="0.1" max="99.9" step="0.1" style="width:60px;" />%</span>
        </div>
        <hr>
        <div style="font-weight:bold; font-size:0.9rem;">Post-test Probability</div>
        <div>
          <span style="font-size:0.8rem;">Positive Test:</span>
          <span><input id="post-positive-input" type="number" min="0.1" max="99.9" step="0.1" style="width:60px;color:red;" />%</span>
        </div>
        <div>
          <span style="font-size:0.8rem;">Negative Test:</span>
          <span><input id="post-negative-input" type="number" min="0.1" max="99.9" step="0.1" style="width:60px;color:green;" />%</span>
        </div>
        <hr>
        <div style="font-weight:bold; font-size:0.9rem;">Likelihood Ratios (LR)</div>
        <div>
          <span style="font-size:0.8rem;">LR+</span>
          <span id="lr-plus" style="font-size:0.8rem;">--</span>
        </div>
        <div>
          <span style="font-size:0.8rem;">LR−</span>
          <span id="lr-minus" style="font-size:0.8rem;">--</span>
        </div>
        <section id="example-values" style="width:100%; margin-top:1rem; padding:1rem; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.04);">
          <div style="font-weight:bold; font-size:0.9rem;">Example values</div>
          <div style="display:flex; gap:1rem; margin-top:0.5rem;">
            <div style="flex:1;">
              <div id="disease-label" style="font-weight:bold; font-size:0.8rem;">Disease</div>
              <select id="example-menu" style="width:100%; margin-top:0.25rem;">
                <option value="">-- Select an example --</option>
                <option value="PE">PE</option>
                <option value="DVT">DVT</option>
                <option value="Infection – subjective CRP">Infection – subjective CRP</option>
                <option value="Bacterial Pneumonia">Bacterial Pneumonia</option>
                <option value="Appendicitis">Appendicitis</option>
                <option value="Sepsis">Sepsis</option>
                <option value="Septic Arthritis">Septic Arthritis</option>
                <option value="Acute Heart Failure">Acute Heart Failure</option>
              </select>
            </div>
            <div style="flex:1;">
              <div id="risk-label" style="display:none; font-weight:bold; font-size:0.8rem;">Risk level</div>
              <select id="pe-risk-menu" style="display:none; width:100%; margin-top:0.25rem;">
                <option value="">-- Select PE risk level --</option>
                <option value="low">Low (~1.3%)</option>
                <option value="intermediate">Intermediate (~16.2%)</option>
                <option value="high">High (~40.6%)</option>
              </select>
            </div>
          </div>
          <div id="test-section" style="display:none; margin-top:0.5rem;">
            <label style="font-weight:bold; font-size:0.8rem;">Test:
              <select id="test-menu" style="margin-left:0.5rem;">
                <option value="">-- Select test --</option>
              </select>
            </label>
          </div>
          <div id="example-data" style="display: none; margin-top: 0.5rem;">
            <!-- Example values will appear here when selected -->
          </div>
          <div id="pe-tests" style="display: none; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:0.5rem;">PE Tests</div>
            <div>
              <div style="font-size:0.7rem;">D-dimer:</div>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ddimer" value="" checked>Unknown</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ddimer" value="neg">Negative</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ddimer" value="pos">Positive</label>
            </div>
            <div style="margin-top:0.5rem;">
              <div style="font-size:0.7rem;">CTPA:</div>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ctpa" value="" checked>Unknown</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ctpa" value="neg">Negative</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-ctpa" value="pos">Positive</label>
            </div>
            <div style="margin-top:0.5rem;">
              <div style="font-size:0.7rem;">V/Q scan:</div>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-vq" value="" checked>Unknown</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-vq" value="neg">Negative</label>
              <label style="font-size:0.6rem;"><input type="radio" name="pe-test-vq" value="pos">Positive</label>
            </div>
          </div>
          <div id="dvt-tests" style="display: none; margin-top:0.5rem; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:0.5rem;">DVT Tests</div>
            <div>
              <div style="font-size:0.7rem;">D-dimer:</div>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ddimer" value="" checked>Unknown</label>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ddimer" value="neg">Negative</label>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ddimer" value="pos">Positive</label>
            </div>
            <div style="margin-top:0.5rem;">
              <div style="font-size:0.7rem;">Ultrasound:</div>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ultrasound" value="" checked>Unknown</label>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ultrasound" value="neg">Negative</label>
              <label style="font-size:0.6rem;"><input type="radio" name="dvt-test-ultrasound" value="pos">Positive</label>
            </div>
          </div>
        </section>
        <section id="settings-section" style="margin-top:1rem;padding:1rem;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
          <label style="font-size:0.8rem;"><input type="checkbox" id="keep-lr-constant" checked /> Fix LRs with ∆PrP</label>
        </section>
      </div>
    </div>
  </main>

  <!-- Help overlay -->
  <div id="help-overlay" style="display: flex;">
    <div class="help-content" style="text-align:center;">
      <h1>Don't Panic</h1>
      <p style="font-style:italic;">help is available…</p>
      <br><br>
      <p>Please click on the <span style="display:inline-flex; align-items:center;"><svg viewBox="0 0 24 24" width="20" height="20" style="margin: 0 0.25rem; position: relative; top: 2px;" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="7" r="1" fill="currentColor"/><rect x="11" y="10" width="2" height="8" fill="currentColor"/></svg></span> for instructions.</p>
    </div>
  </div>

<script>
// ========== app.js inlined ==========
// Fagan Nomogram – mobile‑drag with correct live form ↔ nomogram logic

/**************************** DOM HOOK‑UP ***************************/
const canvas = document.getElementById('faganCanvas');
canvas.style.touchAction = 'none';
const ctx    = canvas.getContext('2d');

const inpPre  = document.getElementById('pretest-input');
const inpPos  = document.getElementById('post-positive-input');
const inpNeg  = document.getElementById('post-negative-input');
const inpSens = document.getElementById('sensitivity-input');
const inpSpec = document.getElementById('specificity-input');

const outLRp  = document.getElementById('lr-plus');
const outLRm  = document.getElementById('lr-minus');
const outSens = document.getElementById('sensitivity');
const outSpec = document.getElementById('specificity');

// hook up the “constant LRs” checkbox
const chkKeepLR = document.getElementById('keep-lr-constant');

/****************************** CONSTANTS ***************************/
const PROB_MIN = 0.1,  PROB_MAX = 99.9;
const LR_MIN   = 0.001, LR_MAX  = 1000;
let SCALE_H = 450, LR_H = SCALE_H/2;
let SCALE_Y0 = 40, LR_Y0 = 40;
const MARGIN_X = 32;
const HIT_R = 20;

/******************************** STATE *****************************/
const S = { pre:10, postPos:75, postNeg:5, lrPlus:null, lrMinus:null, sens:null, spec:null, cssWidth:0, cssHeight:0 };
S.combinedMode = false;  // true when using multi-test example mode
let dragKey = null;

/*************************** MATH HELPERS ***************************/
const clamp = (v,l,h) => Math.min(h, Math.max(l, v));
const odds  = p => p/(100-p);
const prob  = o => (o/(1+o))*100;
const logit = p => Math.log(p/(100-p));

// Helper to convert y back to LR value on the LR axis
function yToLR(y){
  const frac = clamp((y - LR_Y0)/LR_H, 0, 1);              // 0 at top of LR axis, 1 at bottom
  const logLR = Math.log10(LR_MAX) - frac*(Math.log10(LR_MAX)-Math.log10(LR_MIN));
  return Math.pow(10, logLR);
}

/******************** SCALE/GEOMETRY CONVERSION *********************/
function probToY(p,reverse=false){
  p = clamp(p, PROB_MIN, PROB_MAX);
  const frac = (logit(p)-logit(PROB_MIN)) / (logit(PROB_MAX)-logit(PROB_MIN));
  return SCALE_Y0 + (reverse ? (1-frac) : frac)*SCALE_H;
}
function yToProb(y,reverse=false){
  const frac = clamp((y-SCALE_Y0)/SCALE_H, 0,1);
  const L = reverse
    ? logit(PROB_MAX) - (logit(PROB_MAX)-logit(PROB_MIN))*frac
    : logit(PROB_MIN) + (logit(PROB_MAX)-logit(PROB_MIN))*frac;
  return prob(Math.exp(L));
}
function lrToY(lr){
  const frac = (Math.log10(lr)-Math.log10(LR_MIN)) / (Math.log10(LR_MAX)-Math.log10(LR_MIN));
  return LR_Y0 + (1-frac)*LR_H;
}

function isNarrow(){ return window.matchMedia('(max-width:600px)').matches; }

/***************************** POINTS ******************************/
const P = { pretest:{x:0,y:0,color:'blue'}, postPositive:{x:0,y:0,color:'red'}, postNegative:{x:0,y:0,color:'green'} };

/******************* CORE RE‑COMPUTATION FUNCTIONS *****************/
function updateLRPlus(){ S.lrPlus  = odds(S.postPos)/odds(S.pre); }
function updateLRMinus(){S.lrMinus = odds(S.postNeg)/odds(S.pre);}
function updateSensSpec(){
  S.sens = (S.lrPlus*(1-S.lrMinus)) / (S.lrPlus-S.lrMinus);
  S.spec = (S.lrPlus-1) / (S.lrPlus+S.lrMinus);
  S.sens = clamp(S.sens,0,1);
  S.spec = clamp(S.spec,0,1);
}
function updatePostProbs(){
  const o = odds(S.pre);
  S.postPos = clamp(prob(o*S.lrPlus), PROB_MIN, PROB_MAX);
  S.postNeg = clamp(prob(o*S.lrMinus), PROB_MIN, PROB_MAX);
}
function recalc(src){
  switch(src){
    case 'pre':      updateLRPlus(); updateLRMinus(); updateSensSpec(); updatePostProbs(); break;
    case 'postPos':  updateLRPlus();             updateSensSpec(); break;
    case 'postNeg':                   updateLRMinus(); updateSensSpec(); break;
    case 'sens':
    case 'spec':      S.lrPlus  = S.sens /(1-S.spec);
                     S.lrMinus = (1-S.sens)/S.spec;
                     updatePostProbs(); break;
  }
}

/*********************** PUSH STATE → UI HELPERS *******************/
function fmt(n,d=1){ return (+n).toFixed(d).replace(/\.0+$/,''); }
function pushToInputs(force=false){
  const set=(el,v)=>{ if(force||document.activeElement!==el) el.value=v; };
  set(inpPre,   fmt(S.pre));
  set(inpPos,   fmt(S.postPos));
  set(inpNeg,   fmt(S.postNeg));
  set(inpSens,  fmt(S.sens*100));
  set(inpSpec,  fmt(S.spec*100));
}
function pushToOutputs(){
  outLRp.textContent  = fmt(S.lrPlus,1);
  outLRm.textContent  = fmt(S.lrMinus,3);
  if(outSens) outSens.textContent = fmt(S.sens*100)+'%';
  if(outSpec) outSpec.textContent = fmt(S.spec*100)+'%';
}
function pushToCanvas(){
  const leftX  = MARGIN_X;
  const rightX = S.cssWidth - MARGIN_X;
  P.pretest.x      = leftX;
  P.postPositive.x = rightX;
  P.postNegative.x = rightX;
  P.pretest.y      = probToY(S.pre);
  P.postPositive.y = probToY(S.postPos,true);
  P.postNegative.y = probToY(S.postNeg,true);
  draw();
}
function uiRefresh(force=false){ pushToInputs(force); pushToOutputs(); pushToCanvas(); }

/****************************** INPUTS *****************************/
function handleInput(e){
  const id = e.target.id;
  const v  = parseFloat(e.target.value);

  if(id==='pretest-input'){
    S.pre = clamp(v, PROB_MIN, PROB_MAX);
    updatePostProbs();
    uiRefresh();
    return;
  }
  if(id==='post-positive-input'){
    // clear example selection and hide controls when PtP+ changes
    exampleMenu.value = '';
    riskLabel.style.display = 'none';
    peRiskMenu.style.display = 'none';
    testSection.style.display = 'none';
    document.getElementById('pe-tests').style.display = 'none';

    S.postPos = clamp(v, PROB_MIN, PROB_MAX);
    recalc('postPos');
    uiRefresh();
    return;
  }
  if(id==='post-negative-input'){
    // clear example selection and hide controls when PtP- changes
    exampleMenu.value = '';
    riskLabel.style.display = 'none';
    peRiskMenu.style.display = 'none';
    testSection.style.display = 'none';
    document.getElementById('pe-tests').style.display = 'none';

    S.postNeg = clamp(v,PROB_MIN,PROB_MAX);
    recalc('postNeg');
    uiRefresh();
    return;
  }
  if(id==='sensitivity-input'){
    S.sens = clamp(v/100,0.001,0.999);
    recalc('sens');
    uiRefresh();
    return;
  }
  if(id==='specificity-input'){
    S.spec = clamp(v/100,0.001,0.999);
    recalc('spec');
    uiRefresh();
    return;
  }
}



[inpPre,inpPos,inpNeg,inpSens,inpSpec].forEach(el=>el.addEventListener('input', handleInput));


// Allow only numeric input (digits and a single decimal point)
[inpPre, inpPos, inpNeg, inpSens, inpSpec].forEach(el => {
  el.addEventListener('keydown', function(e) {
    // Allow navigation and control keys, including Select All (Ctrl/Cmd + A)
    if (
      [8, 9, 13, 16, 17, 18, 20, 27, 37, 38, 39, 40, 46].includes(e.keyCode) || // Existing allowed keys
      ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a') || // Allow Ctrl+A or Cmd+A
      (e.ctrlKey && ['c', 'v', 'x'].includes(e.key.toLowerCase())) // Allow Ctrl+C, Ctrl+V, Ctrl+X
    ) {
      return;
    }

    // Allow digits
    if (e.key >= '0' && e.key <= '9') {
      return;
    }

    // Allow only one decimal point
    if (e.key === '.') {
      // Prevent entering another decimal if one already exists
      if (this.value.includes('.')) {
        e.preventDefault();
      }
      return;
    }

    // Prevent all other characters
    e.preventDefault();
  });
});


// On blur, round to one decimal and drop trailing zeros
function roundOnBlur(e) {
  const val = parseFloat(e.target.value);
  if (isNaN(val)) return;
  const rounded = Math.round(val * 10) / 10;
  e.target.value = (rounded % 1 === 0) ? rounded.toString() : rounded.toFixed(1).replace(/\.0+$/, '');
  // re-trigger input handling to update nomogram
  handleInput({ target: e.target });
}
[inpPre,inpPos,inpNeg,inpSens,inpSpec].forEach(el =>
  el.addEventListener('blur', roundOnBlur)
);

/****************************** CANVAS *****************************/
function keyAt(x,y){return Object.keys(P).find(k=>((x-P[k].x)**2+(y-P[k].y)**2)<(HIT_R*HIT_R));}
function pDown(e){
  const x = e.offsetX, y = e.offsetY;
  dragKey = keyAt(x, y);
  if (!dragKey) {
    const totalWidth = S.cssWidth - 2 * MARGIN_X;
    const spacing    = totalWidth / 3;
    const AX_PRE     = MARGIN_X + spacing / 2;
    const AX_POST    = MARGIN_X + spacing * 2.5;

    if (x < AX_PRE - HIT_R) {
      dragKey = 'pretest';
    } else if (x > AX_POST + HIT_R) {
      const midY = (P.postPositive.y + P.postNegative.y) / 2;
      if (y < midY) {
        dragKey = 'postPositive';
      } else {
        dragKey = 'postNegative';
      }
    }
  }

  // If no specific drag handle but the press is on the LR axis, start an LR drag
  if (!dragKey) {
    const totalW   = S.cssWidth - 2*MARGIN_X;
    const spacing  = totalW / 3;
    const AX_LR_X  = MARGIN_X + spacing*1.5;          // X for LR axis
    const inBand   = Math.abs(x - AX_LR_X) < spacing*0.1;
    const inYRange = (y >= LR_Y0 && y <= LR_Y0 + LR_H);
    if (inBand && inYRange) {
      const midY = LR_Y0 + LR_H/2;
      dragKey = (y < midY) ? 'lrPlus' : 'lrMinus';    // choose which LR we’re dragging
    }
  }

  if (dragKey) {
    e.preventDefault();
    canvas.setPointerCapture(e.pointerId);
  }
}
function pMove(e) {
  if (!dragKey) return;
  e.preventDefault();

  // Handle LR+ / LR– drag
  if (dragKey === 'lrPlus' || dragKey === 'lrMinus') {
    const ycl = clamp(e.offsetY, LR_Y0, LR_Y0 + LR_H);
    const newLR = clamp(yToLR(ycl), LR_MIN, LR_MAX);
    if (dragKey === 'lrPlus') {
      S.lrPlus = newLR;
    } else {
      S.lrMinus = newLR;
    }
    updatePostProbs();
    updateSensSpec();
    uiRefresh(true);
    return;
  }

  // clamp within the vertical scale
  const ycl = clamp(e.offsetY, SCALE_Y0, SCALE_Y0 + SCALE_H);

  // Pre-test (blue) drag logic with hard stops
  if (dragKey === 'pretest') {
    // compute candidate pre-test probability
    const newPre = yToProb(ycl);

    // enforce hard stops for combined-test or constant-LR modes
    if (S.combinedMode || (chkKeepLR && chkKeepLR.checked)) {
      // compute raw potential post-test (positive) for bound check
      const rawPos = prob(odds(newPre) * S.lrPlus);
      // compute raw potential post-test (negative) for bound check (only if not combined)
      const rawNeg = S.combinedMode ? null : prob(odds(newPre) * S.lrMinus);

      // stop dragging below where any post-test would go below minimum
      if (!S.combinedMode && rawNeg <= PROB_MIN && newPre < S.pre) return;
      if (S.combinedMode && rawPos <= PROB_MIN  && newPre < S.pre) return;
      // stop dragging above where any post-test would exceed maximum
      if (rawPos >= PROB_MAX && newPre > S.pre) return;
    }

    // apply the drag
    P.pretest.y = ycl;
    S.pre = newPre;
    if (chkKeepLR && chkKeepLR.checked) {
      updatePostProbs();
    } else {
      recalc('pre');
    }
    // reset PE/DVT risk level placeholder when dragging PrP
    if (exampleMenu.value === 'PE' || exampleMenu.value === 'DVT') {
      peRiskMenu.value = '';
    }
    uiRefresh(true);
    return;
  }

  // Positive handle drag with hard stops based on LR+
  if (dragKey === 'postPositive') {
    // clear selected disease but keep current values
    document.getElementById('example-menu').value = '';
    document.getElementById('risk-label').style.display = 'none';
    document.getElementById('pe-risk-menu').style.display = 'none';
    document.getElementById('test-section').style.display = 'none';
    document.getElementById('pe-tests').style.display = 'none';
    if (dvtTests) dvtTests.style.display = 'none';
    // exit combined (blue-line) mode when dragging a post-test handle
    S.combinedMode = false;
    const rawPos = yToProb(ycl, true);
    // compute extremes for current LR+
    const maxPos = clamp(prob(odds(PROB_MAX) * S.lrPlus), PROB_MIN, PROB_MAX);
    const minPos = clamp(prob(odds(PROB_MIN) * S.lrPlus), PROB_MIN, PROB_MAX);
    // prevent dragging beyond allowable bounds
    if ((rawPos < minPos && rawPos < S.postPos) || (rawPos > maxPos && rawPos > S.postPos)) return;
    S.postPos = clamp(rawPos, S.postNeg, PROB_MAX);
    recalc('postPos');
  }

  // Negative handle drag with hard stops based on LR–
  if (dragKey === 'postNegative') {
    // clear selected disease but keep current values
    document.getElementById('example-menu').value = '';
    document.getElementById('risk-label').style.display = 'none';
    document.getElementById('pe-risk-menu').style.display = 'none';
    document.getElementById('test-section').style.display = 'none';
    document.getElementById('pe-tests').style.display = 'none';
    if (dvtTests) dvtTests.style.display = 'none';
    // exit combined (blue-line) mode when dragging a post-test handle
    S.combinedMode = false;
    const rawNeg = yToProb(ycl, true);
    // compute extremes for current LR–
    const maxNeg = clamp(prob(odds(PROB_MAX) * S.lrMinus), PROB_MIN, PROB_MAX);
    const minNeg = clamp(prob(odds(PROB_MIN) * S.lrMinus), PROB_MIN, PROB_MAX);
    // prevent dragging beyond allowable bounds
    if ((rawNeg < minNeg && rawNeg < S.postNeg) || (rawNeg > maxNeg && rawNeg > S.postNeg)) return;
    S.postNeg = clamp(rawNeg, PROB_MIN, S.postPos);
    recalc('postNeg');
  }

  uiRefresh(true);
}
function pUp(e){
  dragKey = null;
  canvas.releasePointerCapture(e.pointerId);
}
canvas.addEventListener('pointerdown',pDown);
canvas.addEventListener('pointermove',pMove);
canvas.addEventListener('pointerup',pUp);
canvas.addEventListener('pointerleave',pUp);
canvas.addEventListener('pointercancel',pUp);

/***************************** DRAWING *****************************/
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const tw=S.cssWidth-2*MARGIN_X,gap=tw/3;
  const l=MARGIN_X+gap/2,m=MARGIN_X+gap*1.5,r=MARGIN_X+gap*2.5;
  drawScale(l,true,'Pre-test');drawLR(m);drawScale(r,false,'Post-test');
  Object.entries(P).forEach(([key, pt]) => {
    ctx.save();
    // handle color logic for combined mode
    let color = pt.color;
    if (S.combinedMode && key !== 'pretest' && key !== 'postPositive') return; // skip PtP– handle
    if (S.combinedMode && key === 'postPositive') color = 'blue'; // make combined handle blue
    // draw the handle circle
    ctx.beginPath();
    ctx.arc(pt.x, pt.y, 10, 0, 2 * Math.PI);
    ctx.fillStyle = color;
    ctx.globalAlpha = 0.7;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#fff';
    ctx.stroke();

    // draw the probability value above the handle
    let value;
    if (key === 'pretest') {
      value = fmt(S.pre);
    } else if (key === 'postPositive') {
      value = fmt(S.postPos);
    } else {
      value = fmt(S.postNeg);
    }
    ctx.font = '12px system-ui';
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText(value + '%', pt.x, pt.y - 12);

    ctx.restore();
  });
  drawLines(l,m,r);
}
function drawScale(x,isLeft,label){
  ctx.save();
  ctx.strokeStyle='#333';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(x,SCALE_Y0);ctx.lineTo(x,SCALE_Y0+SCALE_H);ctx.stroke();
  ctx.font='12px system-ui';ctx.textAlign=isLeft?'right':'left';ctx.fillStyle='#000';
  [0.1,0.5,1,2,5,10,25,50,75,90,95,98,99,99.5,99.9].forEach(p=>{
    const y=probToY(p,!isLeft);
    ctx.beginPath();ctx.moveTo(x-6,y);ctx.lineTo(x+6,y);ctx.stroke();
    ctx.fillText(fmt(p),isLeft?x-8:x+8,y+4);
  });
  // draw label centered above scale
  ctx.font='bold 13px system-ui';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  ctx.fillText(label, x, SCALE_Y0 - 10);
  ctx.restore();
}
function drawLR(x){
  ctx.save();
  ctx.strokeStyle='#333'; ctx.lineWidth=2;
  ctx.setLineDash([2,4]);
  ctx.beginPath(); ctx.moveTo(x,LR_Y0); ctx.lineTo(x,LR_Y0+LR_H); ctx.stroke();
  // draw horizontal crossbar at LR = 1 (solid and twice as wide)
  ctx.setLineDash([]);             // ensure solid line
  const y1 = lrToY(1);
  ctx.beginPath();
  ctx.moveTo(x - 12, y1);
  ctx.lineTo(x + 12, y1);
  ctx.stroke();
  ctx.setLineDash([]);  // reset dash for ticks
  ctx.font='14px system-ui';ctx.textAlign='center';ctx.fillStyle='#000';
  [0.001,0.01,0.1,1,10,100,1000].forEach(lr=>{
    const y = lrToY(lr);
    // Use fewer decimals for <1 to avoid trailing zeros
    const label = (lr < 1) ? lr.toString() : fmt(lr,3);
    ctx.fillText(label, x, y + 4);
  });
  // draw LR label centered above LR scale
  ctx.font='bold 13px system-ui';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  ctx.fillText('Likelihood Ratio', x, LR_Y0 - 10);
  // position labels at 2/3 of the vertical gap between the probability and LR axes
  ctx.font = '12px system-ui';
  ctx.textBaseline = 'bottom';
  const labelY = LR_Y0 - 2*(LR_Y0 - SCALE_Y0) / 3;
  ctx.fillText(`Sn: ${fmt(S.sens*100)}%`, x - 30, labelY);
  ctx.fillText(`Sp: ${fmt(S.spec*100)}%`, x + 30, labelY);
  // add LR+ and LR– values just below Sn/Sp
  ctx.fillText(`LR+ ${fmt(S.lrPlus,1)}`, x - 30, labelY + 14);
  ctx.fillText(`LR− ${fmt(S.lrMinus,3)}`, x + 30, labelY + 14);
  ctx.restore();
}
function drawLines(l, m, r) {
  ctx.save();
  ctx.lineWidth = 2.5;

  if (S.combinedMode || (S.lrPlus === 1 && S.lrMinus === 1)) {
    // Single straight blue line for combined test result
    ctx.strokeStyle = 'blue';
    ctx.beginPath();
    ctx.moveTo(l, P.pretest.y);
    ctx.lineTo(r, P.postPositive.y);
    ctx.stroke();
  } else {
    // original red and green lines
    ctx.strokeStyle = 'red';
    ctx.beginPath();
    ctx.moveTo(l, P.pretest.y);
    ctx.lineTo(m, lrToY(S.lrPlus));
    ctx.lineTo(r, P.postPositive.y);
    ctx.stroke();

    ctx.strokeStyle = 'green';
    ctx.beginPath();
    ctx.moveTo(l, P.pretest.y);
    ctx.lineTo(m, lrToY(S.lrMinus));
    ctx.lineTo(r, P.postNegative.y);
    ctx.stroke();
  }

  ctx.restore();
}

/************************** RESIZE HANDLER *************************/
function resizeCanvas(){const dpr=window.devicePixelRatio||1;const cont=document.getElementById('canvas-container');S.cssWidth=cont.offsetWidth;S.cssHeight=cont.offsetHeight;canvas.style.width=S.cssWidth+'px';canvas.style.height=S.cssHeight+'px';canvas.width=Math.round(S.cssWidth*dpr);canvas.height=Math.round(S.cssHeight*dpr);ctx.setTransform(1,0,0,1,0,0);ctx.scale(dpr,dpr);const vf=S.cssHeight/600;SCALE_H=450*vf;LR_H=SCALE_H*0.5;SCALE_Y0=(S.cssHeight-SCALE_H)/2;LR_Y0=(S.cssHeight-LR_H)/2;pushToCanvas();}
window.addEventListener('resize',resizeCanvas);
window.addEventListener('DOMContentLoaded',resizeCanvas);

/************************* INITIALISATION **************************/
function init(){
  S.pre = 10;
  inpPre.value = fmt(S.pre);
  S.sens = 0.778;
  S.spec = 0.741;
  S.lrPlus = S.sens/(1-S.spec);
  S.lrMinus = (1-S.sens)/S.spec;
  updatePostProbs();
  uiRefresh();
}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
(function setupPanel(){
  const container = document.getElementById('output-container');
  const tab       = document.getElementById('slideup-tab');
  const isMobile  = () => window.matchMedia('(max-width:600px)').matches;

  function setMobileState() {
    if (isMobile()) {
      container.classList.remove('slideup');
    } else {
      container.classList.add('slideup');
    }
    // always show the tab, even on desktop
    tab.style.display = 'flex';
  }
  function togglePanel(e) {
    if (e) e.stopPropagation();
    container.classList.toggle('slideup');
  }

  // run on load and wire up the click/resize handlers
  window.addEventListener('DOMContentLoaded', setMobileState);
  tab.addEventListener('click', togglePanel);
  window.addEventListener('resize', setMobileState);
})();

// Help icon toggle
const helpIcon = document.getElementById('help-icon');
const helpOverlay = document.getElementById('help-overlay');
helpIcon.addEventListener('click', () => {
  helpOverlay.style.display = 'flex';
  helpOverlay.innerHTML = `
    <div class="help-content" style="text-align:center;">
      <h1>Using the Fagan Nomogram</h1>
      <p>Set pre‑test probability, choose a disease and test, or input custom values. Then interpret how the test result changes likelihood.</p>
      <br>
      <p>Tap and drag (or click‑and‑drag on desktop) to interact with the graph directly.</p>
      <p style="margin-top: 2rem;">
        <a href="#" id="more-info-link" style="font-size: 0.9rem; color: #2a4a7b; text-decoration: underline;">
          More info on diagnostic reasoning
        </a>
      </p>
    </div>
  `;
  // Stop clicks inside the panel from bubbling up and closing the overlay
  helpOverlay.querySelector('.help-content')
             .addEventListener('click', ev => ev.stopPropagation());

  document.getElementById('more-info-link')?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    helpOverlay.innerHTML = `
      <div class="help-content" style="text-align:left;">
        <h2>More Info on Diagnostic Reasoning</h2>
        <p><strong>Pre-test Probability:</strong> Your starting estimate—how likely the condition is before testing. Often based on clinical impression or rules.</p>
        <p><strong>Sensitivity:</strong> How often a test is positive when the disease is present. High-risk patients need sensitive tests to “rule out”.</p>
        <p><strong>Specificity:</strong> How often a test is negative when the disease is absent. Low-risk patients need specific tests to “rule in”.</p>
        <p><strong>Likelihood Ratios:</strong> These indicate how much a test result shifts probability. LR+ pushes it up; LR– pushes it down.</p>
        <p><strong>Post-test Probability:</strong> This is your updated estimate after the test result. The Fagan Nomogram connects these ideas visually.</p>
        <h3 style="margin-top: 2rem; margin-bottom: 0.5rem;">Important take-home message</h3>
        <p><strong>High-risk</strong> patients need <strong>extremely sensitive</strong> tests even to begin to <strong>rule out</strong> or <strong>exclude</strong> a diagnosis. Conversely, <strong>low-risk</strong> patients need <strong>highly specific</strong> tests to <strong>rule in</strong> or <strong>confirm</strong> a diagnosis with confidence.</p>
      </div>
    `;
    helpOverlay.querySelector('.help-content')
               .addEventListener('click', ev => ev.stopPropagation());
  });
});
helpOverlay.addEventListener('click', () => {
  helpOverlay.style.display = 'none';
});
</script>

<script>
// Example menu logic with PE stratification
const exampleMenu = document.getElementById('example-menu');
const peRiskMenu = document.getElementById('pe-risk-menu');
const riskLabel  = document.getElementById('risk-label');
const exampleData = document.getElementById('example-data');
const testSection    = document.getElementById('test-section');
const testMenu       = document.getElementById('test-menu');
// const singleTestName = document.getElementById('single-test-name');
const multiTests     = document.getElementById('pe-tests');
const dvtTests       = document.getElementById('dvt-tests');

// placeholder for diseases without stratification
const placeholder = 'PrP: --, Sn: --, Sp: --, LR+: --, LR−: --, PtP+: --, PtP−: --';

// Unified testsByDisease object for all examples
const testsByDisease = {
  'PE': {
    pre: 16.2,
    risk: {
      default: 'intermediate',
      options: `
        <option value="">-- Select PE risk level --</option>
        <option value="low">Low (~1.3%)</option>
        <option value="intermediate">Intermediate (~16.2%)</option>
        <option value="high">High (~40.6%)</option>`
    },
    tests: [
      { label: 'D-dimer', value: 'ddimer', sn: 0.99, sp: 0.40 },
      { label: 'CTPA',    value: 'ctpa',   sn: 0.90, sp: 0.96 },
      { label: 'V/Q scan',value: 'vq',     sn: 0.774, sp: 0.977 }
    ]
  },
  'DVT': {
    pre: 5,
    risk: {
      default: 'low',
      options: `
        <option value="">-- Select DVT risk level --</option>
        <option value="low">Low (~5%)</option>
        <option value="moderate">Moderate (~17%)</option>
        <option value="high">High (~53%)</option>`
    },
    tests: [
      { label: 'D-dimer', value: 'D-dimer', sn: 0.95, sp: 0.50 },
      { label: 'Ultrasound', value: 'Ultrasound', sn: 0.95, sp: 0.96 }
    ]
  },
  'Bacterial Pneumonia': {
    pre: 25,
    tests: [
      { label: 'CXR', value: 'CXR', sn: 0.69, sp: 0.83 }
    ]
  },
  'Appendicitis': {
    pre: 25,
    tests: [
      { label: 'AIR Score ≥5', value: 'AIR Score ≥5', sn: 0.92, sp: 0.63 },
      { label: 'AIR Score ≥8', value: 'AIR Score ≥8', sn: 0.20, sp: 0.97 },
      { label: 'Ultrasound', value: 'Ultrasound', sn: 0.85, sp: 0.90 },
      { label: 'CT', value: 'CT', sn: 0.94, sp: 0.95 }
    ]
  },
  'Sepsis': {
    pre: 10,
    tests: [
      { label: 'CRP', value: 'CRP', sn: 0.80, sp: 0.60 },
      { label: 'PCT', value: 'PCT', sn: 0.76, sp: 0.70 }
    ]
  },
  'Septic Arthritis': {
    pre: 10,
    tests: [
      { label: 'CRP >10 mg/L', value: 'CRP >10 mg/L', sn: 0.90, sp: 0.75 }
    ]
  },
  'Infection – subjective CRP': {
    pre: 10,
    tests: [
      { label: 'Subjective CRP interpretation', value: 'Subjective CRP interpretation', sn: 0.778, sp: 0.741 }
    ]
  },
  'Acute Heart Failure': {
    pre: 25,
    tests: [
      { label: 'BNP', value: 'BNP', sn: 0.90, sp: 0.76 },
      { label: 'NT-proBNP', value: 'NT-proBNP', sn: 0.90, sp: 0.75 }
    ]
  }
};

exampleMenu.addEventListener('change', function(e) {
  const key = e.target.value;
  exampleMenu.blur();
  // hide any existing risk or test panels (preserve exampleMenu.value)
  riskLabel.style.display = 'none';
  peRiskMenu.style.display = 'none';
  testSection.style.display = 'none';
  document.getElementById('pe-tests').style.display = 'none';
  // if DVT multi-tests exist
  const dvtPanel = document.getElementById('dvt-tests');
  if (dvtPanel) dvtPanel.style.display = 'none';
  // re-enable inputs
  [inpPos, inpNeg, inpSens, inpSpec].forEach(el => el.disabled = false);
  chkKeepLR.disabled = false;
  S.combinedMode = false;

  const data = testsByDisease[key];
  if (!data) return;

  // Show or hide the risk-level menu
  if (data.risk) {
    riskLabel.style.display = '';
    peRiskMenu.style.display = '';
    peRiskMenu.innerHTML = data.risk.options;
    peRiskMenu.value = data.risk.default;
  } else {
    riskLabel.style.display = 'none';
    peRiskMenu.style.display = 'none';
  }

  // Set pre-test probability
  S.pre = clamp(data.pre, PROB_MIN, PROB_MAX);
  inpPre.value = fmt(S.pre);

  // Initialize Sensitivity/Specificity from the first test
  S.sens = data.tests[0].sn;
  S.spec = data.tests[0].sp;
  recalc('sens');

  // Populate the Test menu
  testSection.style.display = '';
  const opts = data.tests
    .map(t => `<option value="${t.value}">${t.label}</option>`)
    .join('');
  if (data.tests.length === 1) {
    testMenu.innerHTML = opts;
  } else {
    testMenu.innerHTML = `<option value="">-- Select test --</option>${opts}<option value="multiple">Multiple Tests</option>`;
  }
  testMenu.value = data.tests[0].value;

  // Disable manual edits while example is active
  [inpPos, inpNeg, inpSens, inpSpec].forEach(el => el.disabled = true);
  chkKeepLR.disabled = true;

  uiRefresh();
});

// Test selection handler
testMenu.addEventListener('change', function(e) {
  // reset PE multi-test selections to Unknown
  document.querySelectorAll('#pe-tests input[type="radio"]').forEach(radio => radio.checked = (radio.value === ''));
  // reset DVT multi-test selections to Unknown
  if (dvtTests) document.querySelectorAll('#dvt-tests input[type="radio"]').forEach(radio => radio.checked = (radio.value === ''));
  const val = e.target.value;
  // hide both PE and DVT multi-test grids by default
  multiTests.style.display = 'none';
  if (dvtTests) dvtTests.style.display = 'none';
  S.combinedMode = false;

  // mapping for single tests
  const testMap = {
    ddimer: { sn: 0.99, sp: 0.40 },
    ctpa:   { sn: 0.90, sp: 0.96 },
    vq:     { sn: 0.774, sp: 0.977 }
  };

  if (testMap[val]) {
    // single test selected → apply its Sn/Sp, recalc
    S.sens = testMap[val].sn;
    S.spec = testMap[val].sp;
    recalc('sens');
    uiRefresh();
  } else if (val === 'multiple') {
    // multiple tests → show appropriate grid
    if (exampleMenu.value === 'PE') {
      multiTests.style.display = '';
      S.combinedMode = true;
      computePECombinedLR();
    } else if (exampleMenu.value === 'DVT') {
      if (dvtTests) dvtTests.style.display = '';
      S.combinedMode = true;
      computeDVTCombinedLR();
    }
  } else {
    // no test → LRs = 1, single-line
    S.lrPlus  = 1;
    S.lrMinus = 1;
    updatePostProbs();
    uiRefresh();
  }

  // Also handle non-PE example test mapping
  if (!exampleMenu.value || exampleMenu.value === 'PE' || val === 'multiple') return;

  const selected = testMenu.value;
  const allMappings = {
    'D-dimer': { sn: 0.95, sp: 0.50 },
    'Ultrasound': { sn: 0.95, sp: 0.96 },
    'CXR': { sn: 0.69, sp: 0.83 },
    'AIR Score ≥5': { sn: 0.92, sp: 0.63 },
    'AIR Score ≥8': { sn: 0.20, sp: 0.97 },
    'CT': { sn: 0.94, sp: 0.95 },
    'CRP': { sn: 0.80, sp: 0.60 },
    'PCT': { sn: 0.76, sp: 0.70 },
    'BNP': { sn: 0.90, sp: 0.76 },
    'NT-proBNP': { sn: 0.90, sp: 0.75 },
    'CRP >10 mg/L': { sn: 0.90, sp: 0.75 },
    'Best case CRP': { sn: 0.778, sp: 0.741 }
  };

  if (allMappings[selected]) {
    S.sens = allMappings[selected].sn;
    S.spec = allMappings[selected].sp;
    recalc('sens');
    uiRefresh();
  }

  uiRefresh();
  testMenu.blur();
});

// PE risk stratification logic
peRiskMenu.addEventListener('change', function(e) {
  const lvl = e.target.value;
  let mapping = null;
  if (exampleMenu.value === 'PE') {
    mapping = { low: 1.3, intermediate: 16.2, high: 40.6 };
  } else if (exampleMenu.value === 'DVT') {
    mapping = { low: 5, moderate: 17, high: 53 };
  }
  if (mapping && mapping.hasOwnProperty(lvl)) {
    S.pre = mapping[lvl];
    inpPre.value = fmt(S.pre);
    updatePostProbs();
    uiRefresh();
  }
  peRiskMenu.blur();
});

// PE multi-test likelihood combination
function computePECombinedLR() {
  S.combinedMode = true;
  const mapping = {
    ddimer: { sn: 0.99, sp: 0.40 },
    ctpa:   { sn: 0.90, sp: 0.96 },
    vq:     { sn: 0.774, sp: 0.977 }
  };
  let combinedLR = 1.0;

  ['ddimer','ctpa','vq'].forEach(test => {
    const val = document.querySelector(`input[name="pe-test-${test}"]:checked`).value;
    const { sn, sp } = mapping[test];
    const lrPlus  = sn/(1-sp);
    const lrMinus = (1-sn)/sp;
    if (val === 'pos') combinedLR *= lrPlus;
    else if (val === 'neg') combinedLR *= lrMinus;
    // unknown → multiply by 1.0 (no change)
  });

  // apply combined LR and compute post-probs
  S.lrPlus = combinedLR;
  updatePostProbs();

  // clamp the combined post-test line to both ends using combinedLR
  if (S.postPos >= PROB_MAX) {
    // bump pre-test so post-test sits exactly at PROB_MAX
    S.pre = clamp( prob( odds(PROB_MAX) / combinedLR ), PROB_MIN, PROB_MAX );
    updatePostProbs();
  }
  if (S.postPos <= PROB_MIN) {
    // bump pre-test so post-test sits exactly at PROB_MIN
    S.pre = clamp( prob( odds(PROB_MIN) / combinedLR ), PROB_MIN, PROB_MAX );
    updatePostProbs();
  }

  uiRefresh();
}

// DVT multi-test likelihood combination
function computeDVTCombinedLR() {
  S.combinedMode = true;
  const mapping = {
    'dvt-test-ddimer':    { sn:0.95, sp:0.50 },
    'dvt-test-ultrasound':{ sn:0.95, sp:0.96 }
  };
  let combinedLR = 1;
  Object.keys(mapping).forEach(name => {
    const val = document.querySelector(`input[name="${name}"]:checked`).value;
    const {sn, sp} = mapping[name];
    const lrPlus  = sn/(1-sp);
    const lrMinus = (1-sn)/sp;
    if (val === 'pos') combinedLR *= lrPlus;
    else if (val === 'neg') combinedLR *= lrMinus;
  });
  S.lrPlus = combinedLR;
  updatePostProbs();
  uiRefresh();
}
// attach DVT radio listeners
if (dvtTests) {
  document.querySelectorAll('#dvt-tests input[type="radio"]').forEach(radio =>
    radio.addEventListener('change', computeDVTCombinedLR)
  );
}

function resetExampleState() {
  // clear selection
  exampleMenu.value = '';
  // hide PE sub-controls
  peRiskMenu.style.display = 'none';
  document.getElementById('pe-tests').style.display = 'none';
  if (dvtTests) dvtTests.style.display = 'none';
  testSection.style.display = 'none';
  exampleData.style.display = 'none';

  // reset all PE test selections back to “Unknown”
  document.querySelectorAll('#pe-tests input[type="radio"]').forEach(radio => {
    radio.checked = (radio.value === '');
  });
  // reset all DVT test selections back to “Unknown”
  if (dvtTests) {
    document.querySelectorAll('#dvt-tests input[type="radio"]').forEach(radio => {
      radio.checked = (radio.value === '');
    });
  }

  // re-enable all inputs
  [inpPos, inpNeg, inpSens, inpSpec].forEach(el => el.disabled = false);
  chkKeepLR.disabled = false;
  S.combinedMode = false;

  // restore startup defaults
  S.pre     = 10;
  S.sens    = 0.778;
  S.spec    = 0.741;
  S.lrPlus  = S.sens/(1-S.spec);
  S.lrMinus = (1-S.sens)/S.spec;
  updatePostProbs();

  uiRefresh();
}

// attach change listeners to all PE test radios
document.querySelectorAll('#pe-tests input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', computePECombinedLR);
});
</script>

</body>
</html>
